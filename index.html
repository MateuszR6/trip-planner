<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([48.8566, 2.3522], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  let places = JSON.parse(localStorage.getItem('places')) || [];
  let routes = JSON.parse(localStorage.getItem('routes')) || [];
  let markers = [];
  let polylines = [];
  let editingPlaceId = null;
  let routePoints = [];

  function enableAddingMode() {
    alert("Kliknij na mapie, aby dodaƒá punkt.");
    map.once('click', function(e) {
      showTypeDialog(e);
    });
  }

  function showTypeDialog(e) {
    const latlng = e.latlng;
    const dialog = document.createElement('div');
    dialog.className = 'type-dialog';
    dialog.style.left = `${e.originalEvent.pageX}px`;
    dialog.style.top = `${e.originalEvent.pageY}px`;
    dialog.innerHTML = `
      <p>Dodaj:</p>
      <button onclick="confirmAddType('nocleg', ${latlng.lat}, ${latlng.lng}, this)">Nocleg</button>
      <button onclick="confirmAddType('atrakcja', ${latlng.lat}, ${latlng.lng}, this)">Atrakcja</button>
      <button onclick="confirmAddType('jedzenie', ${latlng.lat}, ${latlng.lng}, this)">Jedzenie</button>
    `;
    document.body.appendChild(dialog);
  }

  function confirmAddType(type, lat, lng, btn) {
    const dialog = document.createElement('div');
    dialog.className = 'confirm-dialog';
    dialog.style.left = `${btn.parentElement.style.left}`;
    dialog.style.top = `${btn.parentElement.style.top}`;
    dialog.innerHTML = `
      <p>Potwierd≈∫ dodanie punktu:</p>
      <button onclick="handleAddType('${type}', ${lat}, ${lng}, true, this)">Potwierd≈∫</button>
      <button onclick="handleAddType('${type}', ${lat}, ${lng}, false, this)">Anuluj</button>
    `;
    document.body.appendChild(dialog);
    btn.parentElement.remove();
  }

  function handleAddType(type, lat, lng, confirmed, btn) {
    btn.parentElement.remove();
    if (confirmed) {
      addPlace(type, lat, lng);
    } else {
      alert("Wybierz ponownie miejsce na mapie.");
    }
  }

  function enableRouteAddingMode() {
    alert("Kliknij dwa miejsca na mapie, aby zaznaczyƒá trasƒô.");
    routePoints = [];

    function onMapClick(e) {
      routePoints.push(e.latlng);
      if (routePoints.length === 2) {
        map.off('click', onMapClick);
        showRouteDialog(routePoints);
      }
    }

    map.on('click', onMapClick);
  }

  function showRouteDialog(points) {
    const dialog = document.createElement('div');
    dialog.className = 'route-dialog';
    dialog.style.left = '50%';
    dialog.style.top = '50%';
    dialog.style.transform = 'translate(-50%, -50%)';
    dialog.innerHTML = `
      <p>Potwierd≈∫ trasƒô:</p>
      <button onclick="confirmAddRoute(this)">Potwierd≈∫</button>
      <button onclick="dismissDialog(this)">Anuluj</button>
    `;
    dialog.dataset.points = JSON.stringify(points);
    document.body.appendChild(dialog);
  }

  function confirmAddRoute(btn) {
    const dialog = btn.parentElement;
    const points = JSON.parse(dialog.dataset.points);

    const start = document.getElementById('routeStart').value || "Brak nazwy";
    const end = document.getElementById('routeEnd').value || "Brak nazwy";
    const cost = parseFloat(document.getElementById('routeCost').value) || 0;
    const departure = document.getElementById('departureTime').value || "Brak godziny";
    const arrival = document.getElementById('arrivalTime').value || "Brak godziny";

    const route = { start, end, cost, departure, arrival, points };
    routes.push(route);

    localStorage.setItem('routes', JSON.stringify(routes));
    renderRoutes();
    dialog.remove();
  }

  function dismissDialog(btn) {
    btn.parentElement.remove();
  }

  function renderRoutes() {
    const list = document.getElementById('routesList');
    list.innerHTML = '<h2>üöÜ Lista tras</h2>';

    polylines.forEach(p => map.removeLayer(p));
    polylines = [];

    routes.forEach((route, index) => {
      list.innerHTML += `
        <div class='route'>
          <b>${route.start} ‚û°Ô∏è ${route.end}</b> - ‚Ç¨${route.cost}<br>
          Odjazd: ${route.departure}, Przyjazd: ${route.arrival}
          <button class='edit-btn' onclick='editRoute(${index})'>‚úèÔ∏è Edytuj</button>
          <button class='delete-btn' onclick='deleteRoute(${index})'>Usu≈Ñ</button>
        </div>
      `;

      const polyline = L.polyline(route.points, { color: 'blue' }).addTo(map);
      polylines.push(polyline);
    });
  }

  function deleteRoute(index) {
    routes.splice(index, 1);
    localStorage.setItem('routes', JSON.stringify(routes));
    renderRoutes();
  }

  function addPlace(type, lat, lng) {
    const name = document.getElementById('placeName').value || "Brak nazwy";
    const cost = parseFloat(document.getElementById('placeCost').value) || 0;
    const date = document.getElementById('placeDate').value || "Brak daty";
    const desc = document.getElementById('placeDesc').value || "Brak opisu";

    const id = editingPlaceId || Date.now();
    const place = { id, name, type, cost, date, desc, lat, lng };

    if (editingPlaceId) {
      const index = places.findIndex(p => p.id === editingPlaceId);
      places[index] = place;
      editingPlaceId = null;
    } else {
      places.push(place);
    }

    localStorage.setItem('places', JSON.stringify(places));
    clearForm();
    renderPlaces();
  }

  function clearForm() {
    document.getElementById('placeName').value = '';
    document.getElementById('placeCost').value = '';
    document.getElementById('placeDate').value = '';
    document.getElementById('placeDesc').value = '';
  }

  function renderPlaces() {
    const list = document.getElementById('placesList');
    const filter = document.getElementById('filterType').value;
    list.innerHTML = '<h2>üìç Lista miejsc</h2>';
    let totalCost = 0;

    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const filteredPlaces = filter ? places.filter(p => p.type === filter) : places;

    filteredPlaces.forEach(p => {
      totalCost += p.cost;
      list.innerHTML += `<div class='place'><b>${p.name}</b> (${p.type}) - ‚Ç¨${p.cost}<br>${p.date}<br>${p.desc}
        <button onclick='editPlace(${p.id})'>‚úèÔ∏è Edytuj</button>
        <button class='delete-btn' onclick='deletePlace(${p.id})'>Usu≈Ñ</button></div>`;

      const color = p.type === 'nocleg' ? 'blue' : p.type === 'atrakcja' ? 'green' : 'red';
      const marker = L.marker([p.lat, p.lng], {
        icon: L.divIcon({
          className: 'custom-div-icon',
          html: `<div style="background-color:${color} !important;width:20px;height:20px;border-radius:50%;"></div>`,
          iconSize: [20, 20]
        })
      }).addTo(map);

      marker.bindTooltip(`<b>${p.name}</b><br>${p.type}<br>${p.date}<br>‚Ç¨${p.cost}<br>${p.desc}`, {
        permanent: false,
        direction: 'top'
      });
      markers.push(marker);
    });

    list.innerHTML += `<h3>üí∞ ≈ÅƒÖczny koszt: ‚Ç¨${totalCost}</h3>`;
  }

  renderPlaces();
  renderRoutes();
</script>
