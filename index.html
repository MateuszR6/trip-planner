<!DOCTYPE html><html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa Podróży</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <style>
    body { overscroll-behavior: none; }
    .modal-bg { background-color: rgba(0,0,0,0.5); }
    .scrollbar-thin::-webkit-scrollbar { width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 4px; }
    #map-top { height: 200px; }
  </style>
</head>
<body class="font-sans bg-gray-100 text-gray-800">
  <header class="bg-white shadow p-4 sticky top-0 z-10">
    <h1 class="text-2xl font-bold">Mapa Podróży</h1>
    <div id="map-top" class="mt-2 rounded overflow-hidden"></div>
  </header>
  <main class="flex flex-col md:flex-row h-[calc(100vh-16rem)]">
    <!-- Map Container -->
    <div id="map" class="w-full md:w-2/3 h-full"></div>
    <!-- Sidebar -->
    <div class="w-full md:w-1/3 p-4 overflow-auto scrollbar-thin">
      <!-- Add Point Section -->
      <section id="marker-section" class="mb-6">
        <h2 class="text-xl font-semibold mb-2">Dodaj punkt</h2>
        <form id="markerForm" class="space-y-2">
          <select id="markerType" class="w-full p-2 border rounded">
            <option value="Jedzenie">Jedzenie</option>
            <option value="Nocleg">Nocleg</option>
            <option value="Atrakcja">Atrakcja</option>
          </select>
          <input id="markerName" class="w-full p-2 border rounded" placeholder="Nazwa" required />
          <input id="markerAddress" class="w-full p-2 border rounded" placeholder="Adres (autocomplete)" list="addressSuggestions" />
          <datalist id="addressSuggestions"></datalist>
          <textarea id="markerDesc" class="w-full p-2 border rounded" placeholder="Opis"></textarea>
          <input id="markerCost" type="number" min="0" step="0.01" class="w-full p-2 border rounded" placeholder="Koszt" />
          <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Dodaj punkt</button>
        </form>
      </section><!-- Filter/Search -->
  <div class="mb-6">
    <input id="searchInput" class="w-full p-2 border rounded mb-2" placeholder="Szukaj punktu...">
    <select id="filterType" class="w-full p-2 border rounded">
      <option value="Wszystko">Wszystko</option>
      <option value="Jedzenie">Jedzenie</option>
      <option value="Nocleg">Nocleg</option>
      <option value="Atrakcja">Atrakcja</option>
    </select>
  </div>

  <!-- Lists & Summary -->
  <section id="lists-section" class="space-y-4">
    <div>
      <h3 class="font-semibold">Lista punktów</h3>
      <div id="placesList" class="space-y-2"></div>
    </div>
    <div>
      <h3 class="font-semibold">Podsumowanie kosztów</h3>
      <div id="costSummary" class="space-y-1"></div>
    </div>
  </section>
</div>

  </main>  <!-- Scripts -->  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.2/dist/dexie.min.js"></script>  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>  <script>
    class TravelDB extends Dexie {
      constructor() {
        super('TravelDB');
        this.version(1).stores({ markers: '++id,type,name,address,desc,cost,lat,lng' });
      }
    }
    const db = new TravelDB();

    class MarkerManager {
      static async add(data) { await db.markers.add(data); }
      static async update(id, data) { await db.markers.update(id, data); }
      static async getAll() { return db.markers.toArray(); }
      static async remove(id) { await db.markers.delete(id); }
    }

    class UI {
      static map; static topMap; static markersLayer;
      static async init() {
        UI.map = L.map('map').setView([52.2, 21.0], 6);
        UI.topMap = L.map('map-top', { zoomControl: false, dragging: false }).setView([52.2, 21.0], 5);

        const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' });
        tiles.addTo(UI.map); tiles.addTo(UI.topMap);
        UI.markersLayer = L.markerClusterGroup();
        UI.map.addLayer(UI.markersLayer);

        flatpickr('#departure',{enableTime:true,dateFormat:'Y-m-d H:i'});
        flatpickr('#arrival',{enableTime:true,dateFormat:'Y-m-d H:i'});

        document.getElementById('markerForm').addEventListener('submit', UI.handleAddMarker);
        document.getElementById('filterType').addEventListener('change', UI.renderLists);
        document.getElementById('searchInput').addEventListener('input', UI.renderLists);

        UI.map.on('click', UI.mapClickAdd);
        await UI.renderLists();
      }

      static async mapClickAdd(e) {
        const name = prompt("Nazwa punktu:");
        if (!name) return;
        await MarkerManager.add({type: "Atrakcja", name, address: '', desc: '', cost: 0, lat: e.latlng.lat, lng: e.latlng.lng});
        UI.renderLists();
      }

      static async handleAddMarker(e) {
        e.preventDefault();
        const { markerType: { value: type }, markerName: { value: name }, markerAddress: { value: address }, markerDesc: { value: desc }, markerCost: { value: costRaw } } = e.target;
        const cost = parseFloat(costRaw) || 0;
        const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`).then(r => r.json());
        const { lat, lon } = geo[0] || { lat: 52.2, lon: 21.0 };
        await MarkerManager.add({ type, name, address, desc, cost, lat, lng: lon });
        e.target.reset();
        UI.renderLists();
      }

      static async renderLists() {
        const allMarkers = await MarkerManager.getAll();
        const filter = document.getElementById('filterType').value;
        const search = document.getElementById('searchInput').value.toLowerCase();

        UI.markersLayer.clearLayers();
        const container = document.getElementById('placesList');
        container.innerHTML = '';
        let food = 0, lodging = 0, attr = 0;

        for (const m of allMarkers) {
          if ((filter !== 'Wszystko' && m.type !== filter) || (search && !m.name.toLowerCase().includes(search))) continue;

          const div = document.createElement('div');
          div.className = 'p-2 bg-white rounded shadow';
          div.innerHTML = `<strong>${m.name}</strong><p>${m.type}</p><p>${m.desc}</p><p>${m.address}</p><p>Koszt: ${m.cost.toFixed(2)}</p>`;

          const btnEdit = document.createElement('button');
          btnEdit.textContent = 'Edytuj';
          btnEdit.className = 'text-blue-500 mr-2';
          btnEdit.onclick = async () => {
            const newName = prompt('Nowa nazwa:', m.name);
            if (newName) {
              await MarkerManager.update(m.id, { name: newName });
              UI.renderLists();
            }
          };

          const btnRemove = document.createElement('button');
          btnRemove.textContent = 'Usuń';
          btnRemove.className = 'text-red-500';
          btnRemove.onclick = async () => {
            await MarkerManager.remove(m.id);
            UI.renderLists();
          };

          const btnWrap = document.createElement('div');
          btnWrap.className = 'mt-2';
          btnWrap.append(btnEdit, btnRemove);
          div.append(btnWrap);

          container.appendChild(div);
          const marker = L.marker([m.lat, m.lng]).bindPopup(`<strong>${m.name}</strong><br>${m.desc}`);
          UI.markersLayer.addLayer(marker);

          if (m.type === 'Jedzenie') food += m.cost;
          if (m.type === 'Nocleg') lodging += m.cost;
          if (m.type === 'Atrakcja') attr += m.cost;
        }

        document.getElementById('costSummary').innerHTML =
          `<p>Jedzenie: ${food.toFixed(2)}</p><p>Nocleg: ${lodging.toFixed(2)}</p><p>Atrakcje: ${attr.toFixed(2)}</p><p class="font-bold">Razem: ${(food + lodging + attr).toFixed(2)}</p>`;
      }
    }

    document.addEventListener('DOMContentLoaded', UI.init);
  </script></body>
</html>